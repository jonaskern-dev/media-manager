name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION_NO_V="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_no_v=${VERSION_NO_V}" >> $GITHUB_OUTPUT
          if [[ "${VERSION}" =~ -dev ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "formula_name=media-manager-dev" >> $GITHUB_OUTPUT
            echo "class_name=MediaManagerDev" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "formula_name=media-manager" >> $GITHUB_OUTPUT
            echo "class_name=MediaManager" >> $GITHUB_OUTPUT
          fi

      - name: Download and checksum
        id: checksum
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          BASE="https://github.com/${{ github.repository }}/releases/download/${VERSION}"
          curl -sL "${BASE}/media-manager-darwin-arm64" -o darwin-arm64
          curl -sL "${BASE}/media-manager-darwin-amd64" -o darwin-amd64
          curl -sL "${BASE}/media-manager-linux-arm64" -o linux-arm64
          curl -sL "${BASE}/media-manager-linux-amd64" -o linux-amd64
          echo "sha_darwin_arm64=$(sha256sum darwin-arm64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "sha_darwin_amd64=$(sha256sum darwin-amd64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "sha_linux_arm64=$(sha256sum linux-arm64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "sha_linux_amd64=$(sha256sum linux-amd64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Clone and update tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_UPDATE_TOKEN }}
        run: |
          git clone https://${TAP_TOKEN}@github.com/jonaskern-dev/homebrew-tap.git tap
          cd tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          VERSION="${{ steps.release.outputs.version }}"
          VERSION_NO_V="${{ steps.release.outputs.version_no_v }}"
          FORMULA="${{ steps.release.outputs.formula_name }}"
          CLASS="${{ steps.release.outputs.class_name }}"
          IS_PRE="${{ steps.release.outputs.is_prerelease }}"
          SHA_DA="${{ steps.checksum.outputs.sha_darwin_arm64 }}"
          SHA_DI="${{ steps.checksum.outputs.sha_darwin_amd64 }}"
          SHA_LA="${{ steps.checksum.outputs.sha_linux_arm64 }}"
          SHA_LI="${{ steps.checksum.outputs.sha_linux_amd64 }}"

          if [[ "${IS_PRE}" == "true" ]]; then
            DESC="Media automation platform (development version)"
          else
            DESC="Media automation platform with Save.tv integration and Plex support"
          fi

          mkdir -p Formula
          printf '%s\n' \
            "class ${CLASS} < Formula" \
            "  desc \"${DESC}\"" \
            "  homepage \"https://github.com/jonaskern-dev/media-manager\"" \
            "  version \"${VERSION_NO_V}\"" \
            "  license \"MIT\"" \
            "" \
            "  on_macos do" \
            "    if Hardware::CPU.arm?" \
            "      url \"https://github.com/jonaskern-dev/media-manager/releases/download/${VERSION}/media-manager-darwin-arm64\"" \
            "      sha256 \"${SHA_DA}\"" \
            "      def install" \
            "        bin.install \"media-manager-darwin-arm64\" => \"media-manager\"" \
            "      end" \
            "    else" \
            "      url \"https://github.com/jonaskern-dev/media-manager/releases/download/${VERSION}/media-manager-darwin-amd64\"" \
            "      sha256 \"${SHA_DI}\"" \
            "      def install" \
            "        bin.install \"media-manager-darwin-amd64\" => \"media-manager\"" \
            "      end" \
            "    end" \
            "  end" \
            "" \
            "  on_linux do" \
            "    if Hardware::CPU.arm?" \
            "      url \"https://github.com/jonaskern-dev/media-manager/releases/download/${VERSION}/media-manager-linux-arm64\"" \
            "      sha256 \"${SHA_LA}\"" \
            "      def install" \
            "        bin.install \"media-manager-linux-arm64\" => \"media-manager\"" \
            "      end" \
            "    else" \
            "      url \"https://github.com/jonaskern-dev/media-manager/releases/download/${VERSION}/media-manager-linux-amd64\"" \
            "      sha256 \"${SHA_LI}\"" \
            "      def install" \
            "        bin.install \"media-manager-linux-amd64\" => \"media-manager\"" \
            "      end" \
            "    end" \
            "  end" \
            "" \
            "  test do" \
            "    system \"\#{bin}/media-manager\", \"--version\"" \
            "  end" \
            "end" > "Formula/${FORMULA}.rb"

          ruby -c "Formula/${FORMULA}.rb"
          git add "Formula/${FORMULA}.rb"
          git diff --staged --quiet || git commit -m "feat: update ${FORMULA} to ${VERSION_NO_V}"
          git push
